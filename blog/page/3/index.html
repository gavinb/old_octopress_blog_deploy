
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>antonym.org</title>
  <meta name="author" content="Gavin Baker">

  
  <meta name="description" content="The Cocoa view class NSOpenGLView, which automates all the initialisation required to provide an OpenGL context for drawing, is very useful indeed. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://antonym.org//blog/page/3/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="antonym.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!-- before custom head -->
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
<link rel="openid.server" href="https://indieauth.com/openid" />
<link rel="openid.delegate" href="http://gavinb.antonym.org/" />

  <!-- after custom head -->
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6131956-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><h1>antonym.org</h1>
<h2>Bits by Gavin Baker</h2>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:antonym.org/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/09/nsopenglview-and-text.html">NSOpenGLView and Text</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-09-28T10:28:00+10:00" pubdate data-updated="true">2007-09-28</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Cocoa view class <code>NSOpenGLView</code>, which automates all the initialisation required to provide an OpenGL context for drawing, is very useful indeed.  It would also seem that <code>aglUseFont</code> is a nice simple way to load up a font to draw some text in your view.  So long as it isn&rsquo;t the aforementioned <code>NSOpenGLView</code>, that is.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/09/nsopenglview-and-text.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/01/the-happy-coders-toolkit-part-ii-profiling-and-r.html">The Happy Coder&#8217;s Toolkit Part II: Profiling and R</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-01-02T21:01:00+11:00" pubdate data-updated="true">2007-01-02</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Need to do some performance analysis on the cheap?</p>

<p>Add some debug code to your app to write out the raw numbers you&rsquo;re interested in to a simple text file. Then you post-process the data file. How?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/01/the-happy-coders-toolkit-part-ii-profiling-and-r.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/01/the-happy-coders-toolkit-part-i-mtrace.html">The Happy Coder&#8217;s Toolkit Part I: Mtrace</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-01-02T20:32:00+11:00" pubdate data-updated="true">2007-01-02</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been doing some serious hacking, fixing and refactoring on a codebase for genetics analysis.  And I&rsquo;ve needed tools to go beyond just sprinkling the usual calls to <code>printf</code> around the place to see what&rsquo;s going on.  Hell, I&rsquo;ve even fired up <code>gdb</code> once &ndash; but just to get a stack trace!  This is the first of a sporadically released series on tools I&rsquo;ve found useful.  Hopefully they will distill the essential steps of using these tools, as well as expose some extremely useful but lesser known tricks to a wider audience (like the huge number of readers of this blog).</p>

<h2>mtrace: Debugging malloc</h2>

<p>The memory management provided by the standard <code>libc</code> library with GCC provides a very useful debugging mode, which can be used to detect memory leaks.</p>

<p>To start with, add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;mtrace.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to the includes list at the top of your main module.  Then add a call to <code>mtrace()</code> right at the very top of main, conditionally compiled, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">*</span> <span class="n">envp</span><span class="p">[]</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* locals etc ... */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef MYAPP_DEBUG_ALLOC</span>
</span><span class='line'>    <span class="n">mtrace</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* MYAPP_DEBUG_ALLOC */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* do something funky... */</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will install special handlers to intercept calls to <code>malloc/free</code> et al.  Then you can enable this feature as required.</p>

<p>At runtime, the <code>MALLOC_TRACE</code> environment variable must be set to the name of the output file to store the extra trace data.  If this is not set, <code>mtrace</code> will do <strong>nothing</strong>!</p>

<p>You can run your program like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">%</span> <span class="n">MALLOC_TRACE</span><span class="o">=</span><span class="n">myapp</span><span class="p">.</span><span class="n">mtrace</span> <span class="p">.</span><span class="o">/</span><span class="n">myapp</span> <span class="o">-</span><span class="n">f</span> <span class="mi">123</span> <span class="n">foo</span><span class="p">.</span><span class="n">dat</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once your program has terminated, you can then go ahead and analyse the output using the supplied <code>mtrace</code> tool.  You point it to your binary (so it can pull out the symbol table) and to the saved <code>.mtrace</code> file (from above) and &ndash; behold! &ndash; a big list of all your leakage.</p>

<p>Now all you have to do is tidy up those calls to <code>free</code>!</p>

<p>Stay tuned for the next exciting installments on:</p>

<ul>
<li>gcov</li>
<li>gprof</li>
<li>cflow</li>
<li>Valgrind</li>
<li>and probably not many more&hellip;</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2006/07/autoantonyms.html">Autoantonyms</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2006-07-04T10:10:00+10:00" pubdate data-updated="true">2006-07-04</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>What is the antonym (word of opposite meaning) to the word &ldquo;resign&rdquo;?  One correct answer is &ldquo;resign&rdquo;.  What about the opposite of &ldquo;dust&rdquo;?  Yup, 10 points for &ldquo;dust&rdquo;.</p>

<p>Confused?  These words are <strong>autoantonyms</strong>, one word that can have two opposite meanings!  See a full list of <a href="http://www.fun-with-words.com/nym_autoantonyms.html">autoantonyms at &ldquo;Fun With Words&rdquo;</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2006/04/what-went-wrong.html">What Went Wrong?</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2006-04-19T17:34:00+10:00" pubdate data-updated="true">2006-04-19</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Writing <em>good</em> diagnostic error messages is hard.  But it&rsquo;s worth the effort.  And there&rsquo;s also some side benefits if you take the time, and it&rsquo;s not just avoiding hate-mail from your users.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2006/04/what-went-wrong.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2006/02/surface-plots-of-image-data-in-gnu-r.html">Surface Plots of Image Data in GNU R</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2006-02-07T13:48:00+11:00" pubdate data-updated="true">2006-02-07</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I needed to plot the intensity profile of some test images for my thesis.  It&rsquo;s really useful to be able to visualise 2D grayscale image data by treating the intensity as a height-field and displaying it in 3D.  There&rsquo;s a variety of ways to do this, but I wanted something that would produce good printed results, so EPS was the best output option.</p>

<p>So here&rsquo;s a recipe for using <a href="http://www.r-project.org/">GNU R</a> to produce such a plot.</p>

<p>First, generate your image data and crop it appropriately.  For example, I used <a href="http://www.itk.org/">ITK</a> to generate a Gaussian field.</p>

<p>Then convert it to the <code>pgm</code> file format.  The most excellent <a href="http://www.imagemagick.org/">ImageMagick</a> tools make this a snap (note the &lsquo;%&rsquo; is the shell prompt):</p>

<pre><code>% convert -compress none inputfile.tif inputfile.pgm
</code></pre>

<p>The <code>compress</code> option ensures the PGM file is written in ASCII format, for easy reading in.</p>

<p>Then, fire up R and do the following (note the &lsquo;>&rsquo; character is the default R prompt):</p>

<pre><code>&gt; sz &lt;- scan("gaussian.pgm", what=integer(0), skip=1, comment.char="#", nmax=2)
Read 2 items
&gt; g &lt;- scan("gaussian.pgm", what=integer(0), skip=3, comment.char="#")
Read 65536 items
&gt; gi &lt;- matrix(g, sz[1], sz[2])
&gt; rm(g)
</code></pre>

<p>The first line reads the image size from the PGM header into the variable <tt>sz</tt>, the second reads in the actual data as an array.  The third line creates a matrix from the data, with the appropriate size.  The last line removes the temporary array data.</p>

<p>Now you have a matrix object with your image data in it, you can do all sorts of groovy things.  Such as:</p>

<pre><code>&gt; image(gi)
&gt; contour(gi, add=TRUE)
</code></pre>

<p>[img_assist|fid=13|thumb=1|alt=Gaussian 2D Image Contour plot]</p>

<p>will display it as an image, with a scalar mapping function (which you can customize), along with contour lines showing the isolevels.  But more interesting is this:</p>

<pre><code>&gt; persp(gi, theta=25, phi=30)
</code></pre>

<p>This will produce a 3D contour plot in perspective (the theta and phi parameters rotate the viewing angle).</p>

<p>[img_assist|fid=16|thumb=1|alt=Gaussian 2D Image Perspective plot]</p>

<p>You can also do other handy stuff, like pick out a scanline and do a 2D intensity plot (or a series).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2005/12/unexpected-side-effect.html">Unexpected Side-effect</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2005-12-19T18:54:00+11:00" pubdate data-updated="true">2005-12-19</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I discovered a strange bug in my Python code recently.  It took me a few minutes worth of digging to uncover something somewhat surprising, a side-effect to do with default parameters that is not obvious at first blush.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2005/12/unexpected-side-effect.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2005/12/dropping-privileges-in-python.html">Dropping Privileges in Python</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2005-12-19T18:30:00+11:00" pubdate data-updated="true">2005-12-19</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When writing a small Python web application using the lightweight <a href="http://www.cherrypy.org/">CherryPy</a> framework, I needed the server to run on port 80.  Of course running a server as <code>root</code> is enough to scare even the hardest sysadmin, so I obviously wanted it to drop privs immediately upon startup, once it had opened the default http port.  I wrote the function below to drop privs and switch to a new user and group (usually <code>nobody/nogroup</code>).  It is self-contained, should work with anything &ndash; there is nothing specific to any system.  If you find it useful of have any suggestions to improve it, please leave a comment.</p>

<p>To use this within Cherrypy, set the port to 80 in the cherrypy config file, then add the following before your server start:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">cpg</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">onStartServerList</span> <span class="o">=</span> <span class="p">[</span><span class="n">drop_privileges</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>drop_privileges.py</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'>
</span><span class='line'><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ...</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">drop_privileges</span><span class="p">(</span><span class="n">uid_name</span><span class="o">=</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="n">gid_name</span><span class="o">=</span><span class="s">&#39;nogroup&#39;</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pwd</span><span class="o">,</span> <span class="nn">grp</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">starting_uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
</span><span class='line'>    <span class="n">starting_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">starting_uid_name</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">starting_uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;drop_privileges: started as </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
</span><span class='line'>             <span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">starting_uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>              <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">starting_gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># We&#39;re not root so, like, whatever dude</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">drop_privileges</span><span class="p">:</span> <span class="n">already</span> <span class="n">running</span> <span class="k">as</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">%</span><span class="n">starting_uid_name</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># If we started as root, drop privs and become the specified user/group</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">starting_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Get the uid/gid from the name</span>
</span><span class='line'>        <span class="n">running_uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">uid_name</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>        <span class="n">running_gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">gid_name</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Try setting the new uid/gid</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">running_gid</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not set effective group id: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">running_uid</span><span class="p">)</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not set effective user id: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Ensure a very convervative umask</span>
</span><span class='line'>        <span class="n">new_umask</span> <span class="o">=</span> <span class="mo">077</span>
</span><span class='line'>        <span class="n">old_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">new_umask</span><span class="p">)</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;drop_privileges: Old umask: </span><span class="si">%s</span><span class="s">, new umask: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
</span><span class='line'>                 <span class="p">(</span><span class="nb">oct</span><span class="p">(</span><span class="n">old_umask</span><span class="p">),</span> <span class="nb">oct</span><span class="p">(</span><span class="n">new_umask</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">final_uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
</span><span class='line'>    <span class="n">final_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;drop_privileges: running as </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
</span><span class='line'>             <span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">final_uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>              <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">final_gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Test it</span>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">drop_privileges</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Archived Comments</h2>

<p>AUTHOR: Dan C
DATE: 12/30/2005 11:54:37 PM
Thanks
Hey thanks, this function was exactly what I was looking for! (made me realise I should&rsquo;ve been able to code it myself too :&ndash;). I&rsquo;m running Cherrypy on an embedded system (crazy, I know!) so I want to minimise memory overheads, therefore no Apache or lighttpd with FCGI or anything &mdash; I&rsquo;m just serving everything from the Python HTTP server. I really wanted it to drop privileges so it&rsquo;s not running as root &hellip;</p>

<p>The only problem is, Cherrypy calls the onStartServerList functions <em>before</em> it starts the HTTP server i.e. before it binds to the socket. I can&rsquo;t figure out how to get around it without editing the code for the HTTP server &hellip; any ideas?</p>

<p>AUTHOR: gavinb
DATE: 01/31/2006 12:21:04 PM
Socket binding CherryPy
Hi Dan,</p>

<p>Glad it helped! I&rsquo;ve been using this code successfully for a while to run a private server on port 80.  I went to the CherryPy code to check on the order as you mentioned, and verified that (in at least version 2.0) it calls the onServerStartList functions after it binds to the socket.  I checked both the regular server class and the PooledThreadServer class.</p>

<p>It&rsquo;s possible that in v2.1 (I haven&rsquo;t upgraded yet) they have changed the order of initialisation and binding.  And things are different again now that 2.2 is using WSGI.  I suggest you send your question to the cherrypy mailing list.</p>

<p>Best &ndash; G</p>

<p>AUTHOR: Dwayne Litzenberger
DATE: 11/02/2007 12:36:27 PM
What about os.setgroups()?
You missed something: os.setgroups([]).  Look:</p>

<blockquote><blockquote><blockquote><p>import os
os.setgid(1000)
os.setuid(1000)
os.getgroups()
[0]
os.system(&ldquo;id&rdquo;)
uid=1000(dwon) gid=1000(dwon) groups=0(root)</p>

<hr /></blockquote></blockquote></blockquote>

<p>COMMENT:
AUTHOR: Anonymous
DATE: 08/06/2008 02:59:35 AM
A slight change to make this prettier:
To get the current userid name:</p>

<p>pwd.getpwuid(os.getuid()).pw_name</p>

<p>is better than</p>

<p>pwd.getpwuid(os.getuid())[0]</p>

<p>Marius.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2005/05/who-really-cares-about-usability.html">Who Really Cares About Usability?</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2005-05-31T14:03:00+10:00" pubdate data-updated="true">2005-05-31</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Users, that&rsquo;s who.  They just don&rsquo;t realise it until the computer gets in the way of them doing what they want.</p>

<p>I&rsquo;ve been ranting for years about usability, task-centered design, blah, blah.  I know just how hard it is to get right too.  But both FLOSS and proprietary software are generally abysmal at this sort of thing.</p>

<p><a href="http://nat.org/2005/may/#30-May-2005-10:23-CEST">Nat</a> seems to be catching on to what usability is really all about:</p>

<blockquote><p>&ldquo;It was interesting to watch this video and instantly realize that the &lsquo;Send /
Receive&rsquo; button is all about <em>how Evolution works</em> and not about <em>what
the user wants to do</em>. I&rsquo;ve been staring at that button for five years,
and never realized it was wrong until I saw that video.&rdquo;</p></blockquote>

<p>So I just hope more people make this intellectual leap.  Everywhere, you see examples of the <em>inside-out</em> design, where the implementation is exposed &ndash; warts and all! &ndash; all the way up to the interface.  This is one of the most pervasive errors in design, and it is only getting worse, with more features crammed into every new release.</p>

<p>Imagine: you are designing a VCR remote control.  Does the user really care that it is reading an analog signal from a helical scan magnetic head, with the tape running at 2.1cm/sec?  Do you have a separate button to engage the heads?  A dial to adjust the variable speed motor?  Another dial to adjust the helical rotation speed to match the tape?  Do the users really care how it works inside?  Do they need to know in order to use the player?</p>

<p>Or do they just want to &ldquo;watch the movie&rdquo;?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2005/04/bug-of-the-year.html">Bug of the Year</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2005-04-21T10:14:00+10:00" pubdate data-updated="true">2005-04-21</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I discovered the weirdest bug the other day&hellip;</p>

<p>I had built a new version of the imaging system, tested it and was ready to deploy it.  It was working great on the development box, and it seemed ready to go.  I downloaded the new version on the target machine, and fired it up, expecting to have only a few minutes downtime. And then&hellip;</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2005/04/bug-of-the-year.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/02/c-plus-plus-11-range-based-for-loops.html">C++11 Range-based for loops</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/c-plus-plus-11-futures.html">C++11 Futures</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/c-plus-plus-11-shared-pointer.html">C++11 Smart Pointers: Shared Pointer</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/c-plus-plus-11-unique-pointer.html">C++11 Smart Pointers: Unique Pointer</a>
      </li>
    
      <li class="post">
        <a href="/2013/10/what-is-rust.html">What is Rust?</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Gavin Baker <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'antonym';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

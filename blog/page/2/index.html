
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>antonym.org</title>
  <meta name="author" content="Gavin Baker">

  
  <meta name="description" content="The Standard Template Library (STL) for C++ provides a set of powerful and flexible templated container classes. Never again will you have to hand- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://antonym.org//blog/page/2/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="antonym.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!-- before custom head -->
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  <!-- after custom head -->
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6131956-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><h1>antonym.org</h1>
<h2>Bits by Gavin Baker</h2>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:antonym.org/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2008/05/stl-iterators-and-performance.html">STL Iterators and Performance</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2008-05-30T11:02:00+10:00" pubdate data-updated="true">2008-05-30</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Standard Template Library (STL) for C++ provides a set of powerful and flexible templated container classes.  Never again will you have to hand-craft a doubly-linked list (and get your pointer arithmetic mixed up) &mdash; just use <code>std::list&lt;T&gt;</code>.</p>

<p>Now most of the idiomatic C++ code I&rsquo;ve read that uses STL iterators uses the prefix <code>operator++</code> to move the iterator forward.  And so I had long ago adopted this too, with a vague recollection of having read somewhere that it performed better.  But why?  Good question&hellip; (Updated: fixed formatting, got numbers the right way around.)</p>

<p>The use of the post-increment operator is well established idiomatic code for looping (in both C and C++):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="k">for</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// do something with array[i]</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the indexing variable is an ordinal type (usually an integer), the incrementing order makes no difference.  The expressions <code>++i</code> and <code>i++</code> are identical in this case.  And so many people developing in C++ simply use the same style in C++ with their iterator code.  Why would it matter?</p>

<p>Well, it turns out that it does.  If the indexing variable is a class, such as an iterator, there are some subtle differences between the pre-increment and post-increment operators that may have a big impact on performance.</p>

<p>Referring back to Scott Meyer&rsquo;s wonderful <a href="http://www.amazon.com/More-Effective-C%2B%2B-Addison-Wesley-Professional/dp/020163371X/ref=pd_bbs_sr_1/002-4241626-5806441?ie=UTF8&amp;s=books&amp;qid=1190249817&amp;sr=8-1">More Effective C++</a> book, I tracked down the explanation (item 6, page 31), which I will attempt to reproduce here in simplified form.  The signature of the pre-increment <code>operator++</code> for a class T is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">();</span> <span class="c1">// prefix</span>
</span></code></pre></td></tr></table></div></figure>


<p>while the post-increment operator had a dummy parameter added to make the signature unique:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="k">const</span> <span class="n">T</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span> <span class="kt">int</span> <span class="p">);</span> <span class="c1">// postfix</span>
</span></code></pre></td></tr></table></div></figure>


<p>But that isn&rsquo;t the only difference &ndash; notice that the prefix operator returns a <em>reference</em> to the object itself (permitting chaining of method calls), while the postfix operator returns a <em>const object</em>, semantically defined as the previous value.  (This is for consistency with the behaviour of ordinal types.)</p>

<p>The result is that the pre-increment operator modifies the object in-place, whereas the post-increment operator will result in temporaries being created, invoking the constructor and destructor.  So something as simple as <code>++it</code> versus <code>it++</code> turns out to have some significant side-effects when applied to an object with overloaded operators.  Since this is the case with virtually all iterators in the STL, as well as many other similar objects, it is worth investigating.</p>

<p>So I decided to quantify the difference, to see how much of a difference it made.  I wrote a test program that created a very large (5 million) array of integers, and iterated over the array.  I used a high-resolution timer to time two versions of the loop, identical save for one being pre-increment and one being post-increment.  After a warmup of 3 runs, I ran the test 10 times, collected the timings and compared them.</p>

<p>The results were very interesting: on an Intel workstation, the pre-increment code took an average of 14.1ns per call, while the post-increment code took 27.6ns per call.  That&rsquo;s a significant difference of 49%, or nearly twice as fast!  A plot of 10 iterations each is shown below:</p>

<p><span class="mt-enclosure mt-enclosure-image" style="display: inline;"><a href="http://antonym.org/assets_c/2009/05/results_ppc_g4.html" onclick="http://antonym.org/assets_c/2009/05/results_ppc_g4.html','popup','width=998,height=928,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0'); return false"><img src="http://antonym.org/assets_c/2009/05/results_ppc_g4-thumb-200x185.png" width="200" height="185" alt="results_ppc_g4.png" class="mt-image-center" style="text-align: center; display: block; margin: 0 auto 20px;" /></a></span></p>

<p>So &ndash; it really does improve the performance of your code to write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="n">mylist</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span> <span class="n">it</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">numbers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// do something with *it</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For small arrays, it may not make much of a noticeable difference, but every cycle counts, and a little consistency goes a long way.  Using the prefix increment will enable your application to scale better.</p>

<p>Using the prefix form won&rsquo;t make your actual loop run twice as fast, as the iterator increment is only one component contributing to the performance, and the looping overhead may indeed be swamped by the execution time of the body.  So as always, YMMV!</p>

<p>I have provided the test source in C++, along with an R script to summarise and plot the output.  You can download it via the attachment linked at the end of this article.  The code should compile on any POSIX-conforming system with a decent C++ compiler.  And if you do your own performance tests, please drop me a line and let me know what you found.</p>

<p>As one final note, the wonderful <a href="http://www.boost.org/">Boost++ library</a> provides the <code>foreach</code> module, which provides a powerful wrapper to iterate over containers with a nice clean simple syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">foreach</span><span class="p">(</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">numbers</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">total</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And yes, it uses the pre-increment operator for maximum performance.</p>

<p>Download the source used for this article:</p>

<p><span class="mt-enclosure mt-enclosure-file" style="display: inline;"><a href="http://antonym.org/iterperf/iterperf-0.1.zip">iterperf-0.1.zip</a></span></p>

<p>Archived Comments</p>

<p>AUTHOR: bynio
DATE: 04/15/2009 03:17:24 AM
&ldquo;the post-increment code took an average of 14.1ns per call, while the pre-increment code took 27.6ns per call&rdquo;, so actually post-increment is faster?</p>

<p>AUTHOR: Reid Ellis
DATE: 04/28/2009 01:48:50 AM</p>

<blockquote><em>the post-increment code took an average of 14.1ns per call, while the pre-increment code took 27.6ns per call</em></blockquote>


<p><p />
Do you have these numbers backwards? Because otherwise you are saying that the post-increment code is faster than the pre-increment code.
<p />
Reid</p>

<p>AUTHOR: Gavin Baker
DATE: 05/02/2009 10:50:17 PM
Hi Reid, you&rsquo;re right &ndash; I got the names back-to-front (the article is updated now).  The post-increment is definitely twice as fast, and I have repeated the test on other machines, with the same relative results.</p>

<p>In the migration from my old blog setup, this article lost a plot of the data, as well as the source of the test code.  I&rsquo;ve added the plot and linked the source tarball in here.</p>

<p>:: Gavin</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2008/05/tiger-isnt-really-for-the-users.html">Tiger Isn&#8217;t Really for the Users</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2008-05-18T10:55:00+10:00" pubdate data-updated="true">2008-05-18</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sure, <a href="http://www.apple.com/macosx">Tiger</a> &ndash; the latest release of Apple&rsquo;s Mac OS X &ndash; has a huge array of new features.  Sure, the Spotlight search features alone are compelling enough to make you want to upgrade. Automator enables workflow and user-level scripting.  And Dashboard is a whole new dimension in desktop widgets.</p>

<p>But for all the 200 new features and usability enhancements, that&rsquo;s not what the <em>secret sauce</em> is all about.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2008/05/tiger-isnt-really-for-the-users.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2008/02/debugging-nsbezierpath-drawing.html">Debugging NSBezierPath Drawing</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2008-02-19T21:38:00+11:00" pubdate data-updated="true">2008-02-19</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working on some Cocoa programming, making heavy use of <code>NSBezierPath</code>.  I wished there was an easy way to see just where my control points were ending up, and how the curves were being constructed.  So I wrote a category method to add such a thing to the NSBezierPath class.  It is here for all to share.</p>

<!--break-->


<p>Here&rsquo;s an example of annotating a curve:</p>

<p><img src="http://img.skitch.com/20080219-cp95n9wjm391ptfarkja1hg7xf.png" alt="BezTest1"/></p>

<p>It&rsquo;s very simple, but very handy as you can easily switch from the normal stroking of the path to this annotated version in one line.  It puts blue dots on all the regular points, green dots for the control points, adds lines to join control points to their anchor point, and adds a label so you can see the direction of the control point (so &ldquo;cp3_2&rdquo; is anchored at point 3, on the side of point 2.  It also draws the bounding box in red, so you can see the extents of the full path.</p>

<ul>
<li>Grab the code (MIT license): <a href="http://antonym.org/files/antonym/bezier_debug.zip">bezier_debug.zip</a> (2kB)</li></ul></li>
</ul>


<p>Enjoy!  I&rsquo;d love to get feedback from anyone who tries this.  (Please email me; the comments system is sadly flooded with spam and I may miss legitimate posts.)</p>

<h2>Update: New project hosting</h2>

<p>Thanks to Mathieu Tozer, this little module has been incorporated into the <a href="http://code.google.com/p/morecocoa/">morecocoa</a> project, hosted at Google Project Hosting.  Please obtain the latest source from there.</p>

<ul>
<li><a href="http://code.google.com/p/morecocoa/"><a href="http://code.google.com/p/morecocoa/">http://code.google.com/p/morecocoa/</a></a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2008/01/stl-warts-when-removing-isnt.html">STL Warts - When Removing Isn&#8217;t</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2008-01-01T17:33:00+11:00" pubdate data-updated="true">2008-01-01</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Pop quiz: what does the <code>remove</code> function provided in the C++ STL algorithm package do?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">std</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">begin</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">end</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple question, surely&hellip; Your answer?</p>

<p>If you said &ldquo;it removes the value t from the list between the two iterators&rdquo; then &mdash; bzzzzt, thank you for playing.  It doesn&rsquo;t actually remove anything.  Quoting from the description:</p>

<pre><code>Reorders the range [first,last) to prepare for erasing all elements of equal value.
</code></pre>

<p>So the way to <i>actually</i> erase something from a <code>std::vector</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">v</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">item</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>So all it does is shuffle the items to be deleted to the end, and return an iterator to them.  Then the <code>erase</code> method from the vector snips them off the end.</p>

<p>The above <code>erase/remove</code> line is a standard idiom for actually removing an item by value from a container.</p>

<p>This is one of several poorly named methods in the STL.  There are other design warts which I&rsquo;ll discuss in future articles.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2008/01/a-subtle-bug-involving-c-plus-plus-temporaries.html">A Subtle Bug Involving C++ Temporaries</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2008-01-01T17:26:00+11:00" pubdate data-updated="true">2008-01-01</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I tracked down a subtle little bug the other day.  My code was crashing on a line that should never crash (and we&rsquo;ve all heard that one before!).  It arose from doing two quite innocuous things, but when combined &ndash; disaster!  I decided to write it up as an example to my 3 readers and Google.</p>

<h2>The Setup</h2>

<p>Say you have a Master-Detail relationship between two classes, whereby the master object has a 1:N relationship with the detail objects, and thus has a collection of them.  Let&rsquo;s say it&rsquo;s a vector of pointers (or even better, <a href="http://www.boost.org/">smart ones</a>!).</p>

<p>And as a convenience, the master class has a method which returns a copy of the list <i>by value</i>.  This is quite a reasonable thing to do, especially since the container holds references to the detail objects, and not actual instances.  So we have something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">class</span> <span class="nc">Detail</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Detail</span><span class="o">*&gt;</span> <span class="n">List</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Master</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">Detail</span><span class="o">::</span><span class="n">List</span> <span class="n">getAllDetailedObjects</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_details</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="k">private</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Detail</span><span class="o">::</span><span class="n">List</span> <span class="n">_details</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far, so good&hellip;</p>

<h2>The Bug</h2>

<p>And say some chunk of code wants to do something with all those detail objects, so we might reasonably iterate over the list like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// You probably don&#39;t actually want to do it this way...</span>
</span><span class='line'><span class="n">Detail</span><span class="o">::</span><span class="n">List</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span> <span class="n">it</span> <span class="o">=</span> <span class="n">master</span><span class="p">.</span><span class="n">getAllDetailedObjects</span><span class="p">().</span><span class="n">begin</span><span class="p">();</span>
</span><span class='line'>      <span class="n">it</span> <span class="o">!=</span> <span class="n">master</span><span class="p">.</span><span class="n">getAllDetailedObjects</span><span class="p">().</span><span class="n">end</span><span class="p">();</span>
</span><span class='line'>      <span class="o">++</span><span class="n">it</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Detail</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// do something useful with d</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And of course, this code crashes, right around the dereferencing of the iterator.  Spotted the bug yet?  Take your time, I&rsquo;ll wait here&hellip;</p>

<p>Well, it&rsquo;s a pretty basic error when you know what it is, of course.  Each time <code>getAllDetailedObjects()</code> is being called, a temporary copy of the list is being returned.  So assigning the iterator it to the temporary list&rsquo;s <code>begin()</code> works just fine, except that the temporary list is then destroyed while the iterator is still pointing to its first element.  And so you get to the body of the loop, and you&rsquo;ve got a bad pointer because the temporary list has been thrown away!</p>

<h2>The Solution</h2>

<p>The obvious solution is to avoid temporaries and get only one copy of the list, thus:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// The corrected version...</span>
</span><span class='line'><span class="n">Detail</span><span class="o">::</span><span class="n">List</span> <span class="n">details</span><span class="p">;</span>
</span><span class='line'><span class="n">Detail</span><span class="o">::</span><span class="n">List</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span> <span class="n">it</span> <span class="o">=</span> <span class="n">details</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span><span class='line'>      <span class="n">it</span> <span class="o">!=</span> <span class="n">details</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
</span><span class='line'>      <span class="o">++</span><span class="n">it</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Detail</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// do something with d</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This just goes to show how easy it is to be bitten by side-effects and temporaries in C++.  The compiler provides no help or warning, and there&rsquo;s no proper C++ version of lint that I know of.  This is the sort of thing you just have to pick apart, review all assumptions (&ldquo;the list is valid <b>here</b>!&rdquo;) and beware any time you get a result by value.</p>

<h2>Boost to the rescue! (again)</h2>

<p>The <a href="http://www.boost.org/doc/html/foreach.html">Boost foreach</a> module provides some syntactic sugar to replace all the boilerplate code in iterator loops.</p>

<p>So instead of having to write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">container_type</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span> <span class="n">it</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">container</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">inner_type</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// do something interesting with val</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>you can avoid all the boilerplate code and simply write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">foreach</span> <span class="p">(</span> <span class="n">inner_type</span> <span class="n">val</span><span class="p">,</span> <span class="n">container</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// do something interesting with val</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which is more concise, readable and less typing (or typo-ing!).</p>

<p>And interestingly, it ensures the collection term is evaluated only once, which means it would be safe to iterate over an expression that returns a sequence by value (example from the docs):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">extern</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">get_vector_float</span><span class="p">();</span>
</span><span class='line'><span class="n">foreach</span><span class="p">(</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span> <span class="n">get_vector_float</span><span class="p">()</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// safe: the collection will only be retrieved once</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So using the Boost foreach module would have actually avoided the above bug.  Though it wouldn&rsquo;t be nearly as satisfying, as I wouldn&rsquo;t have been able to blog about it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/12/gloves-off-mercurial-vs-subversion.html">Gloves Off: Mercurial vs Subversion</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-12-04T23:53:00+11:00" pubdate data-updated="true">2007-12-04</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use <a href="http://subversion.tigris.org/">Subversion</a> on a daily basis, and <a href="http://www.selenic.com/mercurial/">Mercurial</a> a few days a week.  I have noticed that Mercurial <em>seems</em> to be faster with a lot of common operations, but I figured it wasn&rsquo;t a fair comparison as Mercurial was always operating locally, while Subversion has to hit the network for many (but certainly not all) operations.</p>

<p>So I decided to do some very rough performance comparisons on a local repository.  And after some quick timings of common operations, this is what I found&hellip;</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/12/gloves-off-mercurial-vs-subversion.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/09/nsopenglview-and-text.html">NSOpenGLView and Text</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-09-28T10:28:00+10:00" pubdate data-updated="true">2007-09-28</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Cocoa view class <code>NSOpenGLView</code>, which automates all the initialisation required to provide an OpenGL context for drawing, is very useful indeed.  It would also seem that <code>aglUseFont</code> is a nice simple way to load up a font to draw some text in your view.  So long as it isn&rsquo;t the aforementioned <code>NSOpenGLView</code>, that is.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/09/nsopenglview-and-text.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/01/the-happy-coders-toolkit-part-ii-profiling-and-r.html">The Happy Coder&#8217;s Toolkit Part II: Profiling and R</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-01-02T21:01:00+11:00" pubdate data-updated="true">2007-01-02</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Need to do some performance analysis on the cheap?</p>

<p>Add some debug code to your app to write out the raw numbers you&rsquo;re interested in to a simple text file. Then you post-process the data file. How?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/01/the-happy-coders-toolkit-part-ii-profiling-and-r.html">Read more &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2007/01/the-happy-coders-toolkit-part-i-mtrace.html">The Happy Coder&#8217;s Toolkit Part I: Mtrace</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2007-01-02T20:32:00+11:00" pubdate data-updated="true">2007-01-02</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been doing some serious hacking, fixing and refactoring on a codebase for genetics analysis.  And I&rsquo;ve needed tools to go beyond just sprinkling the usual calls to <code>printf</code> around the place to see what&rsquo;s going on.  Hell, I&rsquo;ve even fired up <code>gdb</code> once &ndash; but just to get a stack trace!  This is the first of a sporadically released series on tools I&rsquo;ve found useful.  Hopefully they will distill the essential steps of using these tools, as well as expose some extremely useful but lesser known tricks to a wider audience (like the huge number of readers of this blog).</p>

<h2>mtrace: Debugging malloc</h2>

<p>The memory management provided by the standard <code>libc</code> library with GCC provides a very useful debugging mode, which can be used to detect memory leaks.</p>

<p>To start with, add:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;mtrace.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to the includes list at the top of your main module.  Then add a call to <code>mtrace()</code> right at the very top of main, conditionally compiled, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">*</span> <span class="n">envp</span><span class="p">[]</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* locals etc ... */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef MYAPP_DEBUG_ALLOC</span>
</span><span class='line'>    <span class="n">mtrace</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* MYAPP_DEBUG_ALLOC */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* do something funky... */</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will install special handlers to intercept calls to <code>malloc/free</code> et al.  Then you can enable this feature as required.</p>

<p>At runtime, the <code>MALLOC_TRACE</code> environment variable must be set to the name of the output file to store the extra trace data.  If this is not set, <code>mtrace</code> will do <strong>nothing</strong>!</p>

<p>You can run your program like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">%</span> <span class="n">MALLOC_TRACE</span><span class="o">=</span><span class="n">myapp</span><span class="p">.</span><span class="n">mtrace</span> <span class="p">.</span><span class="o">/</span><span class="n">myapp</span> <span class="o">-</span><span class="n">f</span> <span class="mi">123</span> <span class="n">foo</span><span class="p">.</span><span class="n">dat</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once your program has terminated, you can then go ahead and analyse the output using the supplied <code>mtrace</code> tool.  You point it to your binary (so it can pull out the symbol table) and to the saved <code>.mtrace</code> file (from above) and &ndash; behold! &ndash; a big list of all your leakage.</p>

<p>Now all you have to do is tidy up those calls to <code>free</code>!</p>

<p>Stay tuned for the next exciting installments on:</p>

<ul>
<li>gcov</li>
<li>gprof</li>
<li>cflow</li>
<li>Valgrind</li>
<li>and probably not many more&hellip;</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2006/07/autoantonyms.html">Autoantonyms</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2006-07-04T10:10:00+10:00" pubdate data-updated="true">2006-07-04</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>What is the antonym (word of opposite meaning) to the word &ldquo;resign&rdquo;?  One correct answer is &ldquo;resign&rdquo;.  What about the opposite of &ldquo;dust&rdquo;?  Yup, 10 points for &ldquo;dust&rdquo;.</p>

<p>Confused?  These words are <strong>autoantonyms</strong>, one word that can have two opposite meanings!  See a full list of <a href="http://www.fun-with-words.com/nym_autoantonyms.html">autoantonyms at &ldquo;Fun With Words&rdquo;</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/01/boost-now-and-c-plus-plus-11-later.html">Boost now and C++11 later</a>
      </li>
    
      <li class="post">
        <a href="/2013/10/what-is-rust.html">What is Rust?</a>
      </li>
    
      <li class="post">
        <a href="/2011/12/bug-of-the-year-2011.html">Bug of the Year - 2011</a>
      </li>
    
      <li class="post">
        <a href="/2011/03/good-code-gardening.html">Good Code Gardening</a>
      </li>
    
      <li class="post">
        <a href="/2010/04/25-tips-for-intermediate-mercurial-users.html">25 Tips for Intermediate Mercurial Users</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Gavin Baker <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'antonym';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
